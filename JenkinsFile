pipeline {

    environment {
        registry = "gcr.io/analog-pilot-238717/testscript"
        registryCredential = 'analog-pilot-238717'
        dockerImage = ''
      }

    agent {
      kubernetes {
        cloud 'kubernetes'
        label 'docker-slave'
        defaultContainer 'docker-slave'
    }
  }

    stages{
        stage('Build') {
            steps {
            echo "Build docker image"
            script {
                dockerImage = docker.build registry + ":$BUILD_NUMBER"
                pipelineContext.dockerImage = dockerImage
                    }
                }
            }

           stage('Publish'){
            // Setup properties file for deployer
            writeFile file: 'deploy.properties', text: "image=$version"
            archiveArtifacts 'deploy.properties'

            withDockerRegistry([credentialsId: 'analog-pilot-238717', url: 'gcr.io/analog-pilot-238717']) {
                dockerImage.push(version)
                    }
                }
            }

            // We should talk about this... Ass: Eric
            // stage('Api Test') {
            //     when { branch "develop" }
            //     steps {  
            //         script{
            //             image.inside{
            //                 sh 'npm install'
            //                 sh 'npm run test-api'
            //             }
            //         }
            //     }
            // }      
        }
}

